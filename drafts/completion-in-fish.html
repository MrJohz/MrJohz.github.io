<!DOCTYPE html>
<html lang="en">

  <head>
      <meta name="viewport" content="width=device-width, intial-scale=1" />

      <title>Johz</title>
      <link href='//fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,400,600,700' rel='stylesheet' type='text/css' />
      <link href='//fonts.googleapis.com/css?family=Merriweather:300' rel='stylesheet' type='text/css'/>
      <link href='//fonts.googleapis.com/css?family=Source+Code+Pro:200,400,700' rel='stylesheet' type='text/css'/>
      <link rel="stylesheet" type="text/css" href="http://www.johz.me/theme/css/icons.css"/>
      <link rel="stylesheet" type="text/css" href="http://www.johz.me/theme/css/styles.css"/>
      <meta charset="utf-8" />
  </head>

  <body id="index">
    <!-- header -->
    <header class="siteheader">
        <div class= "sitetitle">
          <a class="nodec emph" href="http://www.johz.me">
            Johz
          </a>
        </div>

      <div class = "sitebanner">
        <h3 class ="sitesubtitle">  <script>
    quotes = [
        "The blog that's always right, for an entirely arbitrary value of&nbsp;'right'.",
        "Disclaimer: I have no idea what I'm doing']&lt;&amp;#47;div&gt;); DROP TABLE&nbsp;*;",
        "Currently working towards being 100% <a href='http://xkcd.com/1271'>XKCD/1271</a>&nbsp;compliant.",
        "More than just a blog, it's a way of&nbsp;life.",
        "- zen -",
        "This div container is left deliberately&nbsp;blank.",
        "<a href='https://github.com/MrJohz'>Fork me on GitHub!</a>  Fix an issue with Johz&nbsp;today!",
        "Proud Fenda Scum",
    ]

    index = Math.floor(Math.random() * quotes.length);
    document.write(quotes[index])
  </script>
  <noscript>
    - zen -
  </noscript>
</h3>
        <!-- nav -->
        <nav class="menu">
          <ul>
            <!-- menu items-->
            <!--pages-->
            <!-- services icons -->
          </ul>
        </nav>
      </div> <!-- sitebanner -->
    </header>

    <!-- content -->

<section class="content">

  <h3 class="posttitle">
    <a class="nodec" href="/drafts/completion-in-fish.html" rel="bookmark" title="Permalink to Shell Completion in Fish">
      Shell Completion in Fish
    </a>
  </h3>

  <div class="postinfo">
    <p class="published" title="2015-08-14T14:50:04+01:00">
      Fri 14 August 2015
    </p>

  </div><!-- .postinfo -->

  <div class="article">
    <p>I use the <a href="http://fishshell.com/">fish shell</a> as my go-to shell.  It's fun, it's colourful, it's full of features, and I'd highly recommend it.  One of those features is a shell-completion mechanism in the form of the <code>complete</code> command.  Now many other shells have completion, but for now I'm just going to play with the fish version, and then see if I can apply it to other shells later on, perhaps in a future post.</p>
<p>I'm interested in shell completions because I got bored the other day and started learning <a href="http://rust-lang.org/">Rust</a>, and now I'm trying to build a program that, given an input definition, will output a shell script to define the shell completions for that input.  Yesterday I got to the point that I could just about comprehend the Rust part (if in doubt, stick another "<code>&amp;</code>" in front of it<sup id="fnref:rust-advice"><a class="footnote-ref" href="#fn:rust-advice" rel="footnote">1</a></sup>), and realised that actually the new difficulty was that I didn't really know how to do shell completion.</p>
<h2>First steps - just options</h2>
<p>The best place to start is with a program to define the completions for.  Starting as simple as possible, here's one defined in a sort-of-docopt-y form.</p>
<div class="highlight"><pre>USAGE:
    my-favourite-program [OPTIONS]

OPTIONS:
    -a, --all               Do all the favourite things
    -u                      Only use unsigned integers
    -w, -weird              Weird &quot;old-style&quot; option
</pre></div>


<p>Only options, but three different kinds.  There's short options (<code>-x</code>), long options (<code>--long-opt</code>) and also weird single-dashed long options that fish calls "old-style".  The example given in the fish shell docs is <code>-Wall</code>, but then I've always understood that to be "-W, with the argument 'all'".  Regardless, how do you complete this different options?</p>
<p>The full signature of a program can't be given in one single definition, instead each option is given separately.  The <code>complete</code> command starts by defining what command the completion applies to using the <code>--command</code> option.  This is followed by all of the alternatives for each option, using the <code>--short-option</code> flag for short options, the <code>--long-option</code> flag for long options, and the <code>--old-option</code> flag for old options.  Finally, an optional description can be attached using the <code>--description</code> flag.</p>
<p>The order of the flags passed to <code>complete</code> don't actually matter as far as I can tell, but doing it in the same order each time makes it much easier to read the command, so I'll do it that way.  All in all, that means the completion file might look something like this:</p>
<div class="highlight"><pre><span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> --short-option <span class="s1">&#39;a&#39;</span> --long-option <span class="s1">&#39;all&#39;</span> <span class="se">\</span>
    --description <span class="s1">&#39;Do all the favourite things&#39;</span>
<span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> --short-option <span class="s1">&#39;u&#39;</span> <span class="se">\</span>
    --description <span class="s1">&#39;Only use unsigned integers&#39;</span>
<span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> --short-option <span class="s1">&#39;w&#39;</span> --old-option <span class="s1">&#39;weird&#39;</span> <span class="se">\</span>
    --description <span class="s1">&#39;Weird &quot;old-style&quot; option&#39;</span>
</pre></div>


<p>To test that this works, run those commands in a fish shell, then type <code>my-favourite-program -&lt;tab&gt;</code>.  You should get something that looks a bit like this:</p>
<div class="highlight"><pre><span class="gp">$</span> my-favourite-program -
<span class="go">--all  (Do all the favourite things)  -u  (Only use unsigned integers)  -weird  (Weird &quot;old-style&quot; option)</span>
<span class="go">-a     (Do all the favourite things)  -w    (Weird &quot;old-style&quot; option)</span>
<span class="gp">$</span> my-favourite-program -weird
</pre></div>


<h2>Arguments</h2>
<p>This is all okay, but it's a bit boring.  Many options require an argument of some kind.  How does that work?</p>
<p>Fish has a couple of different switches here.  Firstly, option arguments can be specified using the <code>--arguments</code> option.  <code>--arguments</code> takes a single parameter that takes "a space-separated list of possible option-arguments, which may contain subshells".</p>
<p>There's also some extra switches that specify particulars about how the argument should be treated.  For example, the <code>--require-parameter</code> switch tells fish that a particular argument must have an argument.  This means, among other things, that it can't be used in the middle of a set of short options.  For example, given a command with options <code>-a -b -c</code> where <code>-b</code> has a required parameter, fish shell knows that <code>-ac</code> can still be followed by another option, but that <code>-ab</code> cannot be followed by the <code>-c</code> option, it will be followed by an argument.</p>
<p>Additionally, by default fish will assume that the files in the current directory can always be passed as arguments to the current option.  To prevent this, the <code>--no-files</code> switch can be passed.  <code>--no-files</code> can be combined with <code>--require-parameter</code> using the <code>--exclusive</code> switch.</p>
<p>Let's go back to the original program definition, change it so some of the commands take arguments, and try to fill those arguments in.</p>
<div class="highlight"><pre>USAGE:
    my-favourite-program [OPTIONS]

OPTIONS:
    -f, --file FILE         Include FILE in program
    -x, --extra on|off      Turns extra on or off
    -c, --command COMMAND   The cargo command to execute beforehand
</pre></div>


<p>Okay, so this program is getting more and more contrived.  I've added a few different options to play with to try out different things.</p>
<p>The <code>--file</code> option is probably the easiest one to start with.  It takes any file - that's fish's default anyway.  It is also a required parameter, so the <code>--require-parameter</code> option can be added in.  This is what it looks like:</p>
<div class="highlight"><pre><span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> --short-option <span class="s1">&#39;f&#39;</span> --long-option <span class="s1">&#39;file&#39;</span> <span class="se">\</span>
    --require-parameter <span class="se">\</span>
    --description <span class="s1">&#39;Include FILE in program&#39;</span>
</pre></div>


<p>The second option, <code>--extra</code> is also fairly simple.  It takes either 'on' or 'off' and nothing else.  As there's a required option, and files aren't allowed, this deserves the <code>--exclusive</code> switch, as well as the argument specification.</p>
<div class="highlight"><pre><span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> --short-option <span class="s1">&#39;x&#39;</span> --long-option <span class="s1">&#39;extra&#39;</span> <span class="se">\</span>
    --exclusive --arguments <span class="s1">&#39;on off&#39;</span> <span class="se">\</span>
    --description <span class="s1">&#39;Turns extra on or off&#39;</span>
</pre></div>


<p>You can try both of those fairly easily, although the first one doesn't really do all that much.  The last option, <code>--command</code>, is the most interesting.  It takes a cargo command.  This could be produced by manually typing out all the different cargo commands, but dammit this is the future, and if we aren't allowed hoverboards and ray-guns we might as well use what we have got.</p>
<p>What we have is subshells.  Interestingly, in fish, subshells aren't expanded inside strings as one might expect, which means that the <code>complete</code> command can use them to define short functions that list the available arguments dynamically.  This particular feature isn't necessarily all that useful for listing cargo commands, as those commands are unlikely to change very often, but it is pretty neat and comes in handy elsewhere.</p>
<p>To get a list of cargo commands, I've used <code>cargo --list</code>, removed all of the spaces, and cut off the first line.  It probably isn't the most efficient, but it works.</p>
<div class="highlight"><pre><span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> --short-option <span class="s1">&#39;c&#39;</span> --long-option <span class="s1">&#39;command&#39;</span> <span class="se">\</span>
    --exclusive --arguments <span class="s2">&quot;(cargo --list | tr -d &#39; &#39; | sed &#39;1d&#39;)&quot;</span> <span class="se">\</span>
    --description <span class="s1">&#39;The cargo command to execute beforehand&#39;</span>
</pre></div>


<p>Originally, I thought that the <code>--arguments</code> option only applied to options.  It doesn't - this also works for general arguments.  Assuming <code>my-favourite-program</code> now takes files as arguments, but only accepts files with no 's' in them in the local directory, you might get something like this:</p>
<div class="highlight"><pre><span class="nb">complete</span> --command <span class="s1">&#39;my-favourite-program&#39;</span> <span class="se">\</span>
    --exclusive --arguments <span class="s2">&quot;(ls -p | grep -v &#39;/&#39; | grep -v &#39;s&#39;)&quot;</span> <span class="se">\</span>
    --description <span class="s1">&#39;Argument!&#39;</span>
</pre></div>


<div class="highlight"><pre><span class="gp">$</span> my-favourite-program
<span class="go">fabfile.py   (Argument!)  Makefile     (Argument!)  pelicanconf.py   (Argument!)</span>
<span class="go">fabfile.pyc  (Argument!)  pelican.pid  (Argument!)  pelicanconf.pyc  (Argument!)</span>
</pre></div>


<h2>Subcommands</h2>
<p>S</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:rust-advice">
<p>This is not true&#160;<a class="footnote-backref" href="#fnref:rust-advice" rev="footnote" title="Jump back to footnote 1 in the text">[back]</a></p>
</li>
</ol>
</div>
  </div><!-- .content -->

</section>


    <!-- footer -->
    <footer>
      <p>
        Â© Jonathan Frere, license <a href=""> </a>
        unless otherwise noted.
        Generated by <a href= "http://docs.getpelican.com/">Pelican</a> with
        <a href="http://github.com/porterjamesj/crowsfoot">crowsfoot</a> theme.
      </p>
    </footer>
  </body>
</html>